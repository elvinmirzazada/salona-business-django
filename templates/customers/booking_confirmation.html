<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Confirmed - {{ company_name }}</title>
    {% load static %}
    <link rel="icon" type="image/png" href="{% static 'images/salona-icon.png' %}">
    <link rel="stylesheet" href="{% static 'css/booking_confirmation.css' %}">
</head>
<body>
    <!-- Confetti Animation -->
    <div class="confetti-container" id="confetti-container"></div>

    <div class="confirmation-container">
        <!-- Success Icon -->
        <div class="success-icon-wrapper">
            <div class="success-icon">
                <svg viewBox="0 0 52 52">
                    <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="checkmark" d="M14 27l7.5 7.5L38 18"/>
                </svg>
            </div>
        </div>

        <!-- Confirmation Card -->
        <div class="confirmation-card">
            <h1 class="confirmation-title">üéâ Booking Confirmed!</h1>
            <p class="confirmation-subtitle">
                Thank you for choosing us! We're excited to see you soon.<br>
                A confirmation email has been sent to <strong id="customer-email">Loading...</strong>
            </p>

            <!-- Booking Details -->
            <div class="booking-details">
                <div class="detail-row">
                    <div class="detail-label">
                        <span class="detail-label-icon">üìã</span>
                        Services
                    </div>
                    <div class="detail-value">
                        <ul class="service-list" id="services-list">
                            <li class="service-item">Loading...</li>
                        </ul>
                    </div>
                </div>

                <div class="detail-row" id="professional-row" style="display: none;">
                    <div class="detail-label">
                        <span class="detail-label-icon">üë§</span>
                        Professional
                    </div>
                    <div class="detail-value" id="professional-name">Loading...</div>
                </div>

                <div class="detail-row">
                    <div class="detail-label">
                        <span class="detail-label-icon">üìÖ</span>
                        Date & Time
                    </div>
                    <div class="detail-value" id="datetime-info">
                        Loading...
                    </div>
                </div>

                <div class="detail-row">
                    <div class="detail-label">
                        <span class="detail-label-icon">üí∞</span>
                        Total
                    </div>
                    <div class="detail-value" style="font-size: 1.5rem; color: var(--primary-color);" id="total-price">
                        ‚Ç¨0.00
                    </div>
                </div>
            </div>

            <!-- Venue Information -->
            <div class="venue-info">
                <div class="venue-title">
                    <span class="venue-title-icon">üìç</span>
                    Where to find us
                </div>
                <div class="venue-address">
                    <div class="venue-address-line">
                        <span class="address-icon">üè¢</span>
                        <strong>{{ company_name }}</strong>
                    </div>
                    {% if venue_address %}
                    <div class="venue-address-line">
                        <span class="address-icon">üìç</span>
                        {{ venue_address }}
                    </div>
                    {% endif %}
                    {% if venue_city and venue_postal_code %}
                    <div class="venue-address-line">
                        <span class="address-icon">üó∫Ô∏è</span>
                        {{ venue_postal_code }} {{ venue_city }}
                    </div>
                    {% endif %}
                    {% if venue_phone %}
                    <div class="venue-address-line">
                        <span class="address-icon">üìû</span>
                        {{ venue_phone }}
                    </div>
                    {% endif %}
                </div>
                {% if venue_maps_link %}
                <a href="{{ venue_maps_link }}" target="_blank" class="map-link">
                    <span>üìç</span>
                    <span>Open in Google Maps</span>
                </a>
                {% endif %}
            </div>

            <!-- Additional Info -->
            <div class="additional-info">
                <div class="info-title">
                    <span>‚ÑπÔ∏è</span>
                    Important Information
                </div>
                <ul class="info-list">
                    <li>Please arrive 5-10 minutes before your appointment</li>
                    <li>If you need to cancel or reschedule, please contact us at least 24 hours in advance</li>
                    <li>A confirmation email with all details has been sent to you</li>
                    <li>Feel free to contact us if you have any questions</li>
                </ul>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <a href="/" class="btn btn-primary">
                    <span>üè†</span>
                    <span>Back to Home</span>
                </a>
                <button onclick="window.print()" class="btn btn-secondary">
                    <span>üñ®Ô∏è</span>
                    <span>Print Confirmation</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '{{ API_BASE_URL }}';
        const BOOKING_ID = '{{ booking_id }}';

        // Fetch booking data from API
        async function fetchBookingData() {
            if (!BOOKING_ID || BOOKING_ID === 'None') {
                console.error('No booking ID provided');
                showError('Booking ID not found');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/bookings/${BOOKING_ID}`);
                const result = await response.json();

                console.log('Booking data fetched:', result);

                if (result.success && result.data) {
                    displayBookingData(result.data);

                    // Trigger confetti animation
                    setTimeout(createConfetti, 500);
                } else {
                    throw new Error(result.message || 'Failed to fetch booking data');
                }
            } catch (error) {
                console.error('Error fetching booking data:', error);
                showError('Failed to load booking details. Please contact us for confirmation.');
            }
        }

        // Display booking data on the page
        function displayBookingData(bookingData) {
            // Update customer email
            const customerEmail = bookingData.customer?.email || 'your email';
            const customerName = `${bookingData.customer?.first_name || ''} ${bookingData.customer?.last_name || ''}`.trim();
            document.getElementById('customer-email').textContent = customerEmail;

            // Update services list
            const servicesList = document.getElementById('services-list');
            if (bookingData.booking_services && bookingData.booking_services.length > 0) {
                servicesList.innerHTML = bookingData.booking_services.map(bookingService => {
                    const service = bookingService.category_service;
                    const price = (service.discount_price || service.price || 0) / 100;
                    return `
                        <li class="service-item">
                            <div class="service-name">${service.name}</div>
                            <div class="service-meta">${service.duration} min ‚Ä¢ ‚Ç¨${parseFloat(price).toFixed(2)}</div>
                        </li>
                    `;
                }).join('');
            } else {
                servicesList.innerHTML = '<li class="service-item">No services found</li>';
            }

            // Update professional name if available
            const professionalRow = document.getElementById('professional-row');
            const professionalName = document.getElementById('professional-name');

            if (bookingData.booking_services && bookingData.booking_services.length > 0) {
                // Collect unique professionals from all booking services
                const professionals = new Set();

                bookingData.booking_services.forEach(bookingService => {
                    if (bookingService.assigned_staff) {
                        const staff = bookingService.assigned_staff;
                        const fullName = `${staff.first_name || ''} ${staff.last_name || ''}`.trim();
                        if (fullName) {
                            professionals.add(fullName);
                        }
                    }
                });

                if (professionals.size > 0) {
                    professionalRow.style.display = 'flex';
                    // Display all unique professionals
                    professionalName.textContent = Array.from(professionals).join(', ');
                } else {
                    professionalRow.style.display = 'none';
                }
            } else {
                professionalRow.style.display = 'none';
            }

            // Update date and time
            const datetimeInfo = document.getElementById('datetime-info');
            if (bookingData.start_at) {
                const startDate = new Date(bookingData.start_at);
                const endDate = bookingData.end_at ? new Date(bookingData.end_at) : null;

                // Format date
                const dateStr = startDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Format time
                const timeStr = startDate.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });

                const endTimeStr = endDate ? endDate.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                }) : '';

                datetimeInfo.innerHTML = `
                    ${dateStr}<br>
                    <span style="font-size: 1.125rem; color: var(--primary-color);">
                        ${timeStr}${endTimeStr ? ' - ' + endTimeStr : ''}
                    </span>
                `;
            } else {
                datetimeInfo.textContent = 'Date not available';
            }

            // Update total price
            const totalPrice = document.getElementById('total-price');
            if (bookingData.total_price !== undefined) {
                totalPrice.textContent = `‚Ç¨${(parseFloat(bookingData.total_price) / 100).toFixed(2) }`;
            } else {
                totalPrice.textContent = '‚Ç¨0.00';
            }

            // Update booking status badge (optional - you can add this to the HTML if needed)
            const status = bookingData.status || 'scheduled';
            console.log('Booking status:', status);
        }

        // Show error message
        function showError(message) {
            document.querySelector('.confirmation-subtitle').innerHTML = `
                <span style="color: var(--error-color);">‚ö†Ô∏è ${message}</span>
            `;
            document.getElementById('customer-email').textContent = '';
        }

        // Confetti animation
        function createConfetti() {
            const container = document.getElementById('confetti-container');
            const colors = ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#ec4899'];
            const confettiCount = 50;

            for (let i = 0; i < confettiCount; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    container.appendChild(confetti);

                    // Remove confetti after animation
                    setTimeout(() => {
                        confetti.remove();
                    }, 3500);
                }, i * 30);
            }
        }

        // Load booking data when page loads
        window.addEventListener('load', () => {
            fetchBookingData();
        });
    </script>
</body>
</html>
