<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book an Appointment - Step 2</title>
    {% load static %}
    <style>
        :root {
            --primary: #00A884;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #757575;
            --white: #ffffff;
            --border-radius: 8px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-gray);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Steps indicator */
        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .steps::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--medium-gray);
            z-index: 1;
        }

        .step {
            display: flex;
            align-items: center;
            position: relative;
            z-index: 2;
            background: var(--light-gray);
            padding: 0 10px;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--medium-gray);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }

        .step.active .step-number, .step.completed .step-number {
            background-color: var(--primary);
        }

        .step-text {
            font-size: 16px;
            color: var(--dark-gray);
        }

        .step.active .step-text, .step.completed .step-text {
            color: #333;
            font-weight: bold;
        }

        .step.completed .step-number::after {
            content: '✓';
            position: absolute;
            font-size: 14px;
        }

        /* Section headers */
        h1 {
            font-size: 32px;
            margin-bottom: 20px;
            margin-top: 40px;
        }

        h1:first-child {
            margin-top: 0;
        }

        /* Professional selection */
        .professionals-list {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .professional-card {
            width: 180px;
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            cursor: pointer;
            border: 1px solid var(--medium-gray);
            transition: all 0.2s;
        }

        .professional-card.selected {
            border: 2px solid var(--primary);
        }

        .professional-avatar {
            width: 60px;
            height: 60px;
            background-color: var(--medium-gray);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .professional-avatar.primary {
            background-color: var(--primary);
        }

        .professional-name {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .professional-title {
            color: var(--dark-gray);
            font-size: 14px;
            margin-bottom: 10px;
        }

        .professional-rating {
            display: flex;
            align-items: center;
        }

        .star {
            color: #FFB400;
            margin-right: 5px;
        }

        /* Date selection */
        .calendar {
            margin-bottom: 30px;
        }

        .week-navigation {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .week-nav-btn {
            background: white;
            border: 1px solid var(--medium-gray);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            color: var(--primary);
            font-weight: 500;
        }

        .date-grid {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: space-between;
        }

        .date-cell {
            flex: 1;
            background: white;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-cell.selected, .date-cell.today {
            border-color: var(--primary);
            background-color: var(--primary);
            color: white;
        }

        .date-cell.today {
            font-weight: bold;
        }

        .date-day {
            font-weight: 500;
            margin-bottom: 5px;
        }

        /* Time slot selection */
        .time-slots {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 40px;
        }

        .time-slot {
            padding: 10px 15px;
            background: white;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-slot.selected {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .no-slots {
            padding: 20px;
            text-align: center;
            color: var(--dark-gray);
            width: 100%;
        }

        /* Footer actions */
        .actions {
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
        }

        .back-btn {
            background-color: white;
            color: var(--dark-gray);
            border: 1px solid var(--medium-gray);
            padding: 12px 30px;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            text-transform: uppercase;
        }

        .next-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            text-transform: uppercase;
        }

        .next-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Steps indicator -->
        <div class="steps">
            <div class="step completed">
                <div class="step-number">1</div>
                <div class="step-text">Select Services</div>
            </div>
            <div class="step active">
                <div class="step-number">2</div>
                <div class="step-text">Choose Professional & Time</div>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-text">Review Booking</div>
            </div>
        </div>

        <form id="booking-form" method="post" action="{% url 'customers_booking' company_id=company_id %}">
            {% csrf_token %}
            <input type="hidden" name="step" value="2">
            <input type="hidden" id="selected-professional" name="selected_professional" value="">
            <input type="hidden" id="selected-date" name="selected_date" value="">
            <input type="hidden" id="selected-time-slot" name="selected_time_slot" value="">

            <h1>Select professional</h1>
            <div class="professionals-list" id="professionals-container">
                <!-- Will be populated by JavaScript -->
                <div class="professional-card" data-id="any">
                    <div class="professional-avatar primary">A</div>
                    <div class="professional-name">Any Professional</div>
                    <div class="professional-title">for maximum availability</div>
                    <div class="professional-rating">
                        <span class="star">★</span>
                        <span>5.0</span>
                    </div>
                </div>

                <!-- Additional professionals will be populated via API -->
            </div>

            <div id="time-selection-container" style="display: none;">
                <h1>Select time</h1>
                <div class="calendar">
                    <div class="week-navigation">
                        <button type="button" class="week-nav-btn" id="prev-week-btn">PREVIOUS WEEK</button>
                        <button type="button" class="week-nav-btn" id="next-week-btn">NEXT WEEK</button>
                    </div>
                    <div class="date-grid" id="date-grid">
                        <!-- Date cells will be populated by JavaScript -->
                    </div>
                </div>

                <div class="time-slots" id="time-slots-container">
                    <div class="no-slots">No available slots</div>
                </div>
            </div>

            <div class="actions">
                <a href="{% url 'customers_booking' company_id=company_id %}" class="back-btn">BACK</a>
                <button type="submit" class="next-btn" id="next-button" disabled>NEXT</button>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const companyId = '{{ company_id }}';
            const professionalContainer = document.getElementById('professionals-container');
            const timeSelectionContainer = document.getElementById('time-selection-container');
            const dateGrid = document.getElementById('date-grid');
            const timeSlotsContainer = document.getElementById('time-slots-container');
            const nextButton = document.getElementById('next-button');
            const prevWeekBtn = document.getElementById('prev-week-btn');
            const nextWeekBtn = document.getElementById('next-week-btn');

            // Track selected items
            let selectedProfessional = null;
            let selectedDate = null;
            let selectedTimeSlot = null;
            let currentWeekStart = new Date();
            // Track if we're viewing the initial week
            let isInitialWeek = true;

            // Initialize with the current date
            currentWeekStart = getWeekStart(new Date());

            // Initially disable the previous week button
            prevWeekBtn.disabled = true;

            // Fetch professionals
            fetchProfessionals();

            // Event listeners for week navigation
            prevWeekBtn.addEventListener('click', () => {
                // Get today's date as reference
                const today = getWeekStart(new Date());

                // Move 7 days back, but don't go before today
                const newStart = new Date(currentWeekStart);
                newStart.setDate(newStart.getDate() - 7);

                // If going back would take us before today, just set to today
                if (newStart < today) {
                    currentWeekStart = new Date(today);
                    isInitialWeek = true;
                    prevWeekBtn.disabled = true;
                } else {
                    currentWeekStart = newStart;
                    // We're still in a future week, keep prev button enabled
                }

                renderDateGrid();
                resetTimeSlots();

                // If we have a selected professional, update availability
                if (selectedProfessional) {
                    fetchAvailabilityData(selectedProfessional);
                }
            });

            nextWeekBtn.addEventListener('click', () => {
                // Move to the next week (7 days forward)
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);

                // We're no longer in the initial week
                isInitialWeek = false;
                prevWeekBtn.disabled = false;

                renderDateGrid();
                resetTimeSlots();

                // If we have a selected professional, update availability
                if (selectedProfessional) {
                    fetchAvailabilityData(selectedProfessional);
                }
            });

            async function fetchProfessionals() {
                try {
                    // Updated endpoint to the correct one
                    const response = await fetch(`http://127.0.0.1:8000/api/v1/services/companies/${companyId}/users`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch professionals');
                    }

                    const data = await response.json();
                    if (data.success && data.data) {
                        renderProfessionals(data.data);
                    } else {
                        throw new Error('Invalid response format');
                    }
                } catch (error) {
                    console.error('Error fetching professionals:', error);
                    // Leave the Any Professional option
                }

                // Set up professional selection event listeners
                setupProfessionalSelection();
            }

            function renderProfessionals(professionals) {
                professionals.forEach(item => {
                    // Check if the item has a user property and is active
                    if (item.user && item.status === 'active') {
                        const professional = item.user;

                        const card = document.createElement('div');
                        card.className = 'professional-card';
                        card.dataset.id = professional.id;

                        // Get initials for avatar
                        const initials = getInitials(professional.first_name, professional.last_name);

                        card.innerHTML = `
                            <div class="professional-avatar">${initials}</div>
                            <div class="professional-name">${professional.first_name} ${professional.last_name}</div>
                            <div class="professional-title">${item.role || 'Staff'}</div>
                            <div class="professional-rating">
                                <span class="star">★</span>
                                <span>${professional.rating || '4.9'}</span>
                            </div>
                        `;
                        professionalContainer.appendChild(card);
                    }
                });
            }

            function getInitials(firstName, lastName) {
                let initials = '';
                if (firstName) {
                    initials += firstName.charAt(0);
                }
                if (lastName) {
                    initials += lastName.charAt(0);
                }
                return initials || 'P';
            }

            function setupProfessionalSelection() {
                const professionalCards = document.querySelectorAll('.professional-card');

                professionalCards.forEach(card => {
                    card.addEventListener('click', async function() {
                        // Deselect all cards
                        professionalCards.forEach(c => c.classList.remove('selected'));

                        // Select this card
                        this.classList.add('selected');
                        selectedProfessional = this.dataset.id;

                        // Update hidden field
                        document.getElementById('selected-professional').value = selectedProfessional;

                        // Show time selection
                        timeSelectionContainer.style.display = 'block';

                        // Render date grid
                        renderDateGrid();

                        // Immediately fetch availability data for this professional
                        await fetchAvailabilityData(selectedProfessional);

                        // Scroll to time selection
                        timeSelectionContainer.scrollIntoView({ behavior: 'smooth' });
                    });
                });
            }

            function getWeekStart(date) {
                // Always start from today
                const result = new Date(date);
                // Reset the time to start of day to avoid time zone issues
                result.setHours(0, 0, 0, 0);
                return result;
            }

            function formatDate(date) {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            }

            function renderDateGrid() {
                dateGrid.innerHTML = '';

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Create 7 date cells (today and the next 6 days)
                for (let i = 0; i < 7; i++) {
                    // Calculate the date for this cell (starting from current week start)
                    const currentDate = new Date(currentWeekStart);
                    currentDate.setDate(currentWeekStart.getDate() + i);

                    // Check if this is today's date
                    const isToday = currentDate.getTime() === today.getTime();

                    // Create the date cell element
                    const dateCell = document.createElement('div');
                    dateCell.className = `date-cell${isToday ? ' today' : ''}`;
                    dateCell.dataset.date = formatDate(currentDate);

                    // Format date display
                    const dayOfWeek = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'][currentDate.getDay()];
                    const dayOfMonth = currentDate.getDate();

                    dateCell.innerHTML = `
                        <div class="date-day">${dayOfWeek}</div>
                        <div class="date-number">${dayOfMonth}</div>
                        ${isToday ? '<div class="date-today">(TODAY)</div>' : ''}
                    `;

                    dateCell.addEventListener('click', function() {
                        // Deselect all dates
                        document.querySelectorAll('.date-cell').forEach(cell => {
                            if (!cell.classList.contains('today')) {
                                cell.classList.remove('selected');
                            }
                        });

                        // Select this date
                        if (!this.classList.contains('today')) {
                            this.classList.add('selected');
                        }

                        selectedDate = this.dataset.date;
                        document.getElementById('selected-date').value = selectedDate;

                        // Show time slots for this date from the cached availability data
                        showTimeSlotsForDate(selectedDate);
                    });

                    dateGrid.appendChild(dateCell);
                }

                // Auto-select today
                const todayCell = document.querySelector('.date-cell.today');
                if (todayCell) {
                    selectedDate = todayCell.dataset.date;
                    document.getElementById('selected-date').value = selectedDate;
                }
            }

            // Store availability data for the week
            let weeklyAvailabilityData = null;

            async function fetchAvailabilityData(professionalId) {
                try {
                    resetTimeSlots();

                    // Calculate the date 3 days before today (start of the week view)
                    const dateFrom = formatDate(currentWeekStart);

                    // Use the new API endpoint format
                    const endpoint = professionalId === 'any'
                        ? `http://127.0.0.1:8000/api/v1/companies/${companyId}/availability?date_from=${dateFrom}&availability_type=weekly`
                        : `http://127.0.0.1:8000/api/v1/companies/${companyId}/users/${professionalId}/availability?date_from=${dateFrom}&availability_type=weekly`;

                    const response = await fetch(endpoint);
                    if (!response.ok) {
                        throw new Error('Failed to fetch availability');
                    }

                    const data = await response.json();
                    if (data.success && data.data) {
                        // Store the weekly availability data
                        weeklyAvailabilityData = data.data.weekly;

                        // Show time slots for the selected date
                        if (selectedDate) {
                            showTimeSlotsForDate(selectedDate);
                        }
                    } else {
                        throw new Error('Invalid response format');
                    }
                } catch (error) {
                    console.error('Error fetching availability data:', error);
                    showNoSlots();
                }
            }

            function showTimeSlotsForDate(date) {
                resetTimeSlots();

                if (!weeklyAvailabilityData || !weeklyAvailabilityData.daily_slots) {
                    showNoSlots();
                    return;
                }

                // Find the daily slot data for the selected date
                const dailyData = weeklyAvailabilityData.daily_slots.find(slot => slot.date === date);

                if (!dailyData || !dailyData.time_slots || dailyData.time_slots.length === 0) {
                    showNoSlots();
                    return;
                }

                // Generate 15-minute slots from the available time ranges
                const generatedTimeSlots = generateTimeSlots(dailyData.time_slots);

                if (generatedTimeSlots.length === 0) {
                    showNoSlots();
                    return;
                }

                renderTimeSlots(generatedTimeSlots);
            }

            // Generate 15-minute time slots from available time ranges
            function generateTimeSlots(availableRanges) {
                const allSlots = [];

                availableRanges.filter(range => range.is_available).forEach(range => {
                    // Parse the start and end times
                    const startParts = range.start_time.split(':');
                    const endParts = range.end_time.split(':');

                    // Create Date objects to handle time calculations
                    const startDate = new Date();
                    startDate.setHours(parseInt(startParts[0], 10), parseInt(startParts[1], 10), 0);

                    const endDate = new Date();
                    endDate.setHours(parseInt(endParts[0], 10), parseInt(endParts[1], 10), 0);

                    // Generate 15-minute slots between start and end time
                    const currentTime = new Date(startDate);

                    while (currentTime < endDate) {
                        // Format the current time slot
                        const hours = currentTime.getHours().toString().padStart(2, '0');
                        const minutes = currentTime.getMinutes().toString().padStart(2, '0');
                        const timeSlot = `${hours}:${minutes}`;

                        // Add slot to our array
                        allSlots.push({
                            time: timeSlot,
                            displayTime: formatTimeDisplay(timeSlot)
                        });

                        // Move to next 15-minute slot
                        currentTime.setMinutes(currentTime.getMinutes() + 15);

                        // Don't include the end time if it's exactly at the boundary
                        if (currentTime.getTime() === endDate.getTime()) {
                            break;
                        }
                    }
                });

                // Sort all slots chronologically
                return allSlots.sort((a, b) => a.time.localeCompare(b.time));
            }

            function renderTimeSlots(slots) {
                timeSlotsContainer.innerHTML = '';

                if (!slots || slots.length === 0) {
                    showNoSlots();
                    return;
                }

                slots.forEach(slot => {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    timeSlot.dataset.slot = slot.time;
                    timeSlot.textContent = slot.displayTime;

                    timeSlot.addEventListener('click', function() {
                        // Deselect all time slots
                        document.querySelectorAll('.time-slot').forEach(ts => ts.classList.remove('selected'));

                        // Select this time slot
                        this.classList.add('selected');
                        selectedTimeSlot = this.dataset.slot;
                        document.getElementById('selected-time-slot').value = selectedTimeSlot;

                        // Enable next button
                        nextButton.disabled = false;
                    });

                    timeSlotsContainer.appendChild(timeSlot);
                });
            }

            function formatTimeDisplay(timeString) {
                // Convert "14:00" to "2:00 PM"
                const [hours, minutes] = timeString.split(':');
                let hour = parseInt(hours, 10);
                const period = hour >= 12 ? 'PM' : 'AM';

                hour = hour % 12;
                if (hour === 0) hour = 12;

                return `${hour}:${minutes} ${period}`;
            }

            function showNoSlots() {
                timeSlotsContainer.innerHTML = '<div class="no-slots">No available slots</div>';
            }

            function resetTimeSlots() {
                timeSlotsContainer.innerHTML = '<div class="no-slots">No available slots</div>';
                selectedTimeSlot = null;
                document.getElementById('selected-time-slot').value = '';
                nextButton.disabled = true;
            }
        });
    </script>
</body>
</html>
